<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Menu - Admin Dashboard</title>
    <link rel="stylesheet" href="admin.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Cormorant+Garamond:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav>
                <div class="logo">
                    <img src="../media/logo-icon.png" alt="Healthy Food Logo">
                </div>
                <ul>
                    <li><a href="index.html">Dashboard Home</a></li>
                    <li><a href="manage-menu.html" class="active">Manage Menu</a></li>
                    <li><a href="orders.html">View Orders</a></li>
                    <li><a href="order-status.html">Update Order Status</a></li>
                    <li><a href="reports.html">View Reports</a></li>
                    <li><a href="manage-admins.html">Admin & Delivery Management</a></li>
                </ul>
                <button class="logout-btn" id="logout-btn">Logout</button>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Topbar -->
            <header class="topbar">
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="logo">
                    <img src="../media/logo-icon.png" alt="Healthy Food Logo">
                    <span>Admin Panel</span>
                </div>
                <div class="actions" style="display: flex; align-items: center; gap: 20px; margin-left: auto;">
                    <div class="admin-info">
                        Welcome, Admin
                    </div>
                    <button class="icon-btn" id="notifications-btn" title="Notifications"><i class="fas fa-bell"></i></button>
                    <button class="icon-btn" id="settings-btn" title="Settings"><i class="fas fa-cog"></i></button>
                    <button class="icon-btn" id="profile-btn" title="Profile"><i class="fas fa-user-circle"></i></button>
                    <button id="theme-toggle" class="theme-toggle-btn"><i class="fas fa-sun"></i></button>
                </div>
            </header>

            <!-- Content Area -->
            <main class="content">
                <h1 style="font-family: 'Cormorant Garamond', serif; font-size: 36px; margin-bottom: 30px; color: var(--text-color);">Manage Menu</h1>

                <!-- Add Dish Section -->
                <div class="card">
                    <h3>Add New Dish</h3>
                    <form style="margin-top: 15px;" id="add-dish-form">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label for="dish-name">Dish Name</label>
                                <input type="text" id="dish-name" name="name" placeholder="e.g., Grilled Chicken Salad" required>
                            </div>
                            <div class="form-group">
                                <label for="dish-category">Category</label>
                                <select id="dish-category" name="category" required>
                                    <option value="">Select Category</option>
                                    <option value="Dishes">Dishes</option>
                                    <option value="Juice">Juice</option>
                                    <option value="Dessert">Dessert</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label for="dish-price">Price ($)</label>
                                <input type="number" id="dish-price" name="price" step="0.01" placeholder="15.99" required>
                            </div>
                            <div class="form-group">
                                <label for="dish-image-file">Dish Image</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="file" id="dish-image-file" name="image" accept="image/*" required style="border: 1px solid #ccc; padding: 5px; border-radius: 5px;">
                                    <img id="image-preview" src="" alt="Preview" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px; display: none;">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="dish-description">Description</label>
                            <textarea id="dish-description" name="description" rows="3" placeholder="Describe the dish..." required></textarea>
                        </div>
                        <button type="submit" class="btn">Add Dish</button>
                    </form>
                </div>
                
                <!-- Menu List -->
                <div class="card" style="margin-top: 30px;">
                    <h3>Current Menu Items</h3>
                    <div id="menu-list-container">Loading...</div>
                </div>

            </main>
        </div>
    </div>
    
    <script src="admin.js"></script>
    <script>
        // Inline script to handle menu management using the shared admin.js API
        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById('add-dish-form');
            const listContainer = document.getElementById('menu-list-container');
            const fileInput = document.getElementById('dish-image-file');
            const imgPreview = document.getElementById('image-preview');

            // Image Preview Handler
            fileInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imgPreview.src = e.target.result;
                        imgPreview.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                } else {
                    imgPreview.style.display = 'none';
                }
            });
            
            async function loadMenu() {
                try {
                    const menu = await API.getMenu();
                    listContainer.innerHTML = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${menu.map(item => `
                                    <tr>
                                        <td><img src="${item.image_url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;"></td>
                                        <td>${item.name}</td>
                                        <td>${item.category}</td>
                                        <td>$${item.price}</td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" onclick="deleteDish(${item.id})">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } catch (error) {
                    listContainer.innerHTML = 'Error loading menu';
                }
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const nameVal = (formData.get('name') || '').toString().trim();
                formData.set('name', nameVal || '');
                const descVal = (formData.get('description') || '').toString().trim();
                formData.set('description', descVal || '');
                const catVal = (formData.get('category') || '').toString().trim();
                formData.set('category', catVal || '');
                const priceRaw = (formData.get('price') || '').toString().trim();
                let priceVal = 'null';
                if (priceRaw !== '') {
                    const n = Number(priceRaw);
                    if (Number.isFinite(n)) {
                        priceVal = (Math.round(n * 100) / 100).toFixed(2);
                    }
                }
                formData.set('price', priceVal);
                const file = fileInput && fileInput.files ? fileInput.files[0] : null;
                if (!file) {
                    formData.delete('image');
                    formData.set('image_url', 'null');
                } else {
                    formData.delete('image_url');
                }
                
                try {
                    await API.addMenuItem(formData);
                    alert('Dish added successfully');
                    form.reset();
                    imgPreview.style.display = 'none';
                    loadMenu();
                } catch (error) {
                    alert('Failed to add dish: ' + error.message);
                }
            });

            window.deleteDish = async (id) => {
                if (confirm('Are you sure?')) {
                    try {
                        await API.deleteMenuItem(id);
                        loadMenu();
                    } catch (error) {
                        alert('Failed to delete dish');
                    }
                }
            };

            loadMenu();
        });
    </script>
</body>
</html>
